<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Controle de Estoque</title>
  <link rel="stylesheet" href="/path/to/stylesIndex.css">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Lexend+Peta:wght@100..900&display=swap" rel="stylesheet">
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      fetch('/api/verifyToken', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      }).then(response => {
        if (!response.ok) {
          throw new Error('Token inválido');
        }
        return response.json();
      }).then(data => {
        console.log(data); // Adicione este log para depuração
        if (data.success) {
          if (data.user.role === 'admin') {
            document.getElementById('cadastroBtn').disabled = false;
            document.getElementById('entradaBtn').disabled = false;
            document.getElementById('saidaBtn').disabled = false;
            document.getElementById('openReportPage').disabled = false;
            document.getElementById('abrirEstoque').disabled = false;
            document.getElementById('cadastroPedidoBtn').style.display = 'block'; // Mostra o botão de cadastro de pedidos
            document.querySelectorAll('.alterar-situacao').forEach(btn => btn.style.display = 'inline-block');
          } else {
            document.getElementById('abrirEstoque').disabled = false;
          }
        } else {
          throw new Error('Token inválido');
        }
      }).catch(error => {
        console.error(error); // Adicione este log para depuração
        localStorage.removeItem('token');
        window.location.href = '/login.html';
      });

      carregarPedidosRecentes();
    });

    function carregarPedidosRecentes() {
      fetch('/api/pedidosRecentes')
        .then(response => response.json())
        .then(data => {
          const pedidosRecentes = document.getElementById('pedidosRecentes');
          pedidosRecentes.innerHTML = '';

          if (data.success && data.pedidos.length > 0) {
            let conteudoTabela = `<table border="1">
              <tr>
                <th>Número do Pedido</th>
                <th>Seção</th>
                <th>Depósito</th>
                <th>Situação</th>
                <th>Ação</th>
              </tr>`;

            data.pedidos.forEach(pedido => {
              conteudoTabela += `<tr>
                <td>${pedido.numero}</td>
                <td>${pedido.secao}</td>
                <td>${pedido.deposito}</td>
                <td>${pedido.situacao}</td>
                <td>
                  <select class="alterar-situacao" data-id="${pedido.id}" style="display: none;">
                    <option value="em separação" ${pedido.situacao === 'em separação' ? 'selected' : ''}>Em Separação</option>
                    <option value="aguardando retirada" ${pedido.situacao === 'aguardando retirada' ? 'selected' : ''}>Aguardando Retirada</option>
                    <option value="concluído" ${pedido.situacao === 'concluído' ? 'selected' : ''}>Concluído</option>
                  </select>
                </td>
              </tr>`;
            });

            conteudoTabela += '</table>';
            pedidosRecentes.innerHTML = conteudoTabela;

            document.querySelectorAll('.alterar-situacao').forEach(select => {
              select.addEventListener('change', function () {
                const id = this.dataset.id;
                const situacao = this.value;
                alterarSituacaoPedido(id, situacao);
              });
            });

            const token = localStorage.getItem('token');
            fetch('/api/verifyToken', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              }
            }).then(response => response.json()).then(data => {
              if (data.success && data.user.role === 'admin') {
                document.querySelectorAll('.alterar-situacao').forEach(select => {
                  select.style.display = 'inline-block';
                });
              }
            });
          } else {
            pedidosRecentes.innerHTML = '<p>Nenhum pedido recente encontrado.</p>';
          }
        })
        .catch(error => {
          console.error('Erro ao carregar pedidos recentes:', error);
        });
    }

    function alterarSituacaoPedido(id, situacao) {
      fetch(`/api/pedidos/${id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({ situacao })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            carregarPedidosRecentes();
          } else {
            alert('Erro ao alterar situação do pedido.');
          }
        })
        .catch(error => {
          console.error('Erro ao alterar situação do pedido:', error);
        });
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login.html';
    }

    function abrirCadastroPedido() {
      window.open('cadastro_pedido.html', 'Cadastro de Pedido', 'width=1200,height=800');
    }
  </script>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1 id="h1">ALMOXARIFADO</h1>
    </header>
    <div class="background-overlay"></div>
    <main class="container-buttons">
      <div class="buttons-wrapper">
        <div class="button-wrapper">
          <button id="cadastroBtn" onclick="abrirCadastro()" disabled>
            <img src="/path/to/cadastro_icon.png" alt="Cadastro de Produto">
            <span>Cadastro de Produto</span>
          </button>
        </div>
        <div class="button-wrapper">
          <button id="entradaBtn" onclick="abrirEntrada()" disabled>
            <img src="/path/to/entrada_icon.png" alt="Entrada de Produto">
            <span>Entrada de Produto</span>
          </button>
        </div>
        <div class="button-wrapper">
          <button id="saidaBtn" onclick="abrirSaida()" disabled>
            <img src="/path/to/saida_icon.png" alt="Saída de Produto">
            <span>Saída de Produto</span>
          </button>
        </div>
        <div class="button-wrapper">
          <button id="abrirEstoque" onclick="abrirEstoque()" disabled>
            <img src="/path/to/estoque_icon.png" alt="Estoque">
            <span>Estoque</span>
          </button>
        </div>
        <div class="button-wrapper">
          <button id="openReportPage" onclick="gerarRelatorios()" disabled>
            <img src="/path/to/relatorio_icon.png" alt="Gerar Relatórios">
            <span>Relatórios</span>
          </button>
        </div>
        <div class="button-wrapper">
          <button onclick="logout()">
            <img src="/path/to/logout_icon.png" alt="Logout">
            <span>Logout</span>
          </button>
        </div>
      </div>
      <div class="button-wrapper">
        <button id="cadastroPedidoBtn" onclick="abrirCadastroPedido()" style="display: none;">
          <img src="/path/to/cadastro_icon.png" alt="Cadastro de Pedido">
          <span>Cadastro de Pedido</span>
        </button>
      </div>
    </main>
    <div id="widgets-container">
      <div class="widget" id="pedidosRecentesWidget">
        <h2>Pedidos Recentes</h2>
        <div id="pedidosRecentes"></div>
      </div>
    </div>
  </div>
  <footer class="footer">
    Controle de Estoque do Almoxarifado - Desenvolvido pelo 2º Sgt Nilton
  </footer>
  <script src="js/main.js"></script>
  <script src="js/pedidosRecentes.js"></script>
</body>
</html>
